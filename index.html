<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Interaktives Fahrzeugzustandsprotokoll</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111833;
      --ink:#e9eefc;
      --muted:#a9b4d6;
      --line:rgba(233,238,252,.15);
      --accent:#7aa2ff;
      --danger:#ff6b6b;
      --ok:#35d39a;
      --warning:#ffd166;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #070a14);
      color:var(--ink);
    }
    .wrap{
      max-width:1100px;
      margin: 24px auto 64px;
      padding: 0 16px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .title h1{
      margin:0;
      font-size: 26px;
      letter-spacing:.2px;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      line-height:1.35;
      max-width:70ch;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.03);
      color:var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .card{
      background: rgba(17,24,51,.7);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .field label{
      font-size: 12px;
      color:var(--muted);
    }
    input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea{
      width:100%;
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      color:var(--ink);
      border-radius: 10px;
      padding:10px 10px;
      outline:none;
    }
    textarea{ min-height: 70px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(233,238,252,.45); }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(122,162,255,.6);
      box-shadow: 0 0 0 3px rgba(122,162,255,.15);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{ border-color: rgba(122,162,255,.6); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(122,162,255,.35), rgba(122,162,255,.15));
      border-color: rgba(122,162,255,.65);
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,107,107,.25), rgba(255,107,107,.08));
      border-color: rgba(255,107,107,.55);
    }
    .btn.small{ padding: 7px 10px; border-radius: 10px; font-size: 12px; }
    .section-title{
      margin: 18px 0 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .section-title h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .section-title p{
      margin:0;
      color:var(--muted);
      font-size: 12px;
    }
    .divider{
      height:1px;
      background: var(--line);
      margin: 14px 0;
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      text-align:left;
      background: rgba(255,255,255,.03);
    }
    tr:last-child td{ border-bottom:none; }
    .status{
      width: 150px;
    }
    .note-cell textarea{ min-height: 44px; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.03);
    }
    .tag.ok{ border-color: rgba(53,211,154,.45); color: rgba(53,211,154,.95); }
    .tag.bad{ border-color: rgba(255,107,107,.55); color: rgba(255,107,107,.95); }

    .photo-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .photo-grid{ grid-template-columns: repeat(2, 1fr); }
      header{ flex-direction:column; align-items:flex-start; }
    }
    .photo-card{
      border: 1px dashed rgba(233,238,252,.25);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.02);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .photo-card .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .photo-card .meta strong{
      font-size: 13px;
      line-height:1.2;
    }
    .photo-card .meta span{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .photo-card input[type="file"]{
      width:100%;
      padding:10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    .preview{
      width:100%;
      aspect-ratio: 4 / 3;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .preview img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:none;
    }
    .preview .hint{
      color: rgba(233,238,252,.55);
      font-size: 12px;
      padding: 10px;
      text-align:center;
    }

    .sig-wrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .sig-wrap{ grid-template-columns: 1fr; }
    }
    .sig{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,.02);
    }
    .sig .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    canvas{
      width:100%;
      height: 180px;
      border-radius: 12px;
      border:1px dashed rgba(233,238,252,.25);
      background: rgba(0,0,0,.18);
      touch-action: none;
    }

    .error{
      border-color: rgba(255,107,107,.75) !important;
      box-shadow: 0 0 0 3px rgba(255,107,107,.15) !important;
    }
    .msg{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .msg.error{
      border-color: rgba(255,107,107,.55);
      color: rgba(255,107,107,.95);
      background: rgba(255,107,107,.08);
      box-shadow: none !important;
    }
    .msg.ok{
      border-color: rgba(53,211,154,.45);
      color: rgba(53,211,154,.95);
      background: rgba(53,211,154,.08);
    }
    .muted{ color: var(--muted); }

    /* Better mobile editing + scrollable tables */
    .table-scroll{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border-radius: 12px;
    }
    .table-scroll table{
      min-width: 820px;
    }
    @media (max-width: 520px){
      input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea{
        font-size: 16px; /* prevents iOS zoom + improves typing */
      }
    }

    /* Inline photo collector (for Schäden + Zustandsabfrage) */
    .photo-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .file-hidden{ display:none; }
    .thumbs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .thumb{
      position:relative;
      width:44px;
      height:44px;
      flex: 0 0 auto;
    }
    .thumb img{
      width:44px;
      height:44px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid rgba(233,238,252,.18);
    }
    .thumb button{
      position:absolute;
      top:-6px;
      right:-6px;
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(233,238,252,.25);
      background: rgba(0,0,0,.55);
      color: var(--ink);
      cursor:pointer;
      font-size:12px;
      line-height:16px;
      padding:0;
    }
    .smallnote{
      color: var(--muted);
      font-size: 11px;
      margin-top: 6px;
      line-height: 1.25;
    }


    /* Print */
    @media print{
      body{ background:#fff; color:#000; }
      .wrap{ max-width:none; margin:0; padding:0; }
      .card{ box-shadow:none; background:#fff; border-color:#ddd; }
      header, .no-print{ display:none !important; }
      input, select, textarea{
        border-color:#bbb !important;
        background:#fff !important;
        color:#000 !important;
        box-shadow:none !important;
      }
      table{ border-color:#bbb; }
      th{ color:#000; background:#f3f3f3; }
      .preview{ border-color:#bbb; background:#fff; }
      canvas{ display:none; }
      .sig img{ display:block !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Interaktives Fahrzeugzustandsprotokoll</h1>
        <p>
          Digitales Protokoll zur Fahrzeug-Übergabe/Rückgabe inklusive Pflichtfotos.
          Alles bleibt lokal im Browser, bis du auf <b>Senden</b> klickst. Danach kannst du teilen, drucken oder als PDF speichern.
        </p>
      </div>
      <div class="pill">Tipp: Auf dem Smartphone lassen sich Fotos direkt mit der Kamera aufnehmen.</div>
    </header>

    <div class="card">
      <div class="row no-print" style="justify-content:space-between; gap:12px;">
        <div class="row" style="gap:8px;">
          <button class="btn primary" id="btnSend" type="button">Senden</button>
          <button class="btn" id="btnPrint" type="button">Druckansicht / PDF</button>
          <button class="btn" id="btnExportJson" type="button">Export JSON</button>
          <button class="btn" id="btnReset" type="button">Alles zurücksetzen</button>
        </div>
        <span class="muted" style="font-size:12px;">Version 1.1 - Sendefunktion + Fotos in Zustand/Schaden</span>
      </div>

      <div class="section-title">
        <h2>1) Allgemeine Angaben</h2>
        <p>Pflichtfelder sind mit * markiert.</p>
      </div>

      <div class="grid">
        <div class="field" style="grid-column: span 3;">
          <label for="process">Vorgang *</label>
          <select id="process" required>
            <option value="">Bitte auswählen ...</option>
            <option>Übergabe</option>
            <option>Rückgabe</option>
            <option>Zwischenkontrolle</option>
          </select>
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="date">Datum *</label>
          <input id="date" type="date" required>
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="time">Uhrzeit *</label>
          <input id="time" type="time" required>
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="location">Standort / Filiale *</label>
          <input id="location" type="text" placeholder="z.B. Berlin Mitte" required>
        </div>

        <div class="field" style="grid-column: span 4;">
          <label for="company">Unternehmen / Betrieb (optional)</label>
          <input id="company" type="text" placeholder="Firma / Fuhrpark">
        </div>
        <div class="field" style="grid-column: span 4;">
          <label for="employee">Mitarbeiter *</label>
          <input id="employee" type="text" placeholder="Vorname Nachname" required>
        </div>
        <div class="field" style="grid-column: span 4;">
          <label for="customer">Kunde / Fahrer (optional)</label>
          <input id="customer" type="text" placeholder="Vorname Nachname">
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>2) Fahrzeugdaten</h2>
        <p>Bitte Daten vom Fahrzeugschein/Display übernehmen.</p>
      </div>

      <div class="grid">
        <div class="field" style="grid-column: span 3;">
          <label for="plate">Kennzeichen *</label>
          <input id="plate" type="text" placeholder="z.B. B-AB 1234" required>
        </div>
        <div class="field" style="grid-column: span 5;">
          <label for="model">Marke / Modell *</label>
          <input id="model" type="text" placeholder="z.B. VW Golf" required>
        </div>
        <div class="field" style="grid-column: span 4;">
          <label for="vin">FIN / VIN (optional)</label>
          <input id="vin" type="text" placeholder="17-stellig">
        </div>

        <div class="field" style="grid-column: span 3;">
          <label for="color">Farbe (optional)</label>
          <input id="color" type="text" placeholder="z.B. Schwarz">
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="mileage">Kilometerstand (km) *</label>
          <input id="mileage" type="number" min="0" step="1" placeholder="z.B. 54210" required>
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="fuel">Tank / Batterie (%) *</label>
          <input id="fuel" type="number" min="0" max="100" step="1" placeholder="0-100" required>
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="keys">Anzahl Schlüssel *</label>
          <input id="keys" type="number" min="0" step="1" value="2" required>
        </div>

        <div class="field" style="grid-column: span 12;">
          <label for="notesGeneral">Bemerkungen (optional)</label>
          <textarea id="notesGeneral" placeholder="z.B. Hinweis auf Vorschaden, Winterreifen, Besonderheiten ..."></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>3) Zubehör / Dokumente</h2>
        <p>Haken setzen, wenn vorhanden.</p>
      </div>

      <div class="grid">
        <div class="field" style="grid-column: span 12;">
          <div class="row" style="gap:14px; align-items:flex-start;">
            <label class="tag"><input type="checkbox" id="acc_triangle"> Warndreieck</label>
            <label class="tag"><input type="checkbox" id="acc_firstaid"> Verbandskasten</label>
            <label class="tag"><input type="checkbox" id="acc_vest"> Warnweste(n)</label>
            <label class="tag"><input type="checkbox" id="acc_docs"> Zulassung/Papiere</label>
            <label class="tag"><input type="checkbox" id="acc_charging"> Lade-/Kabel (EV/Hybrid)</label>
            <label class="tag"><input type="checkbox" id="acc_spare"> Reserverad/Pannenset</label>
            <label class="tag"><input type="checkbox" id="acc_tools"> Bordwerkzeug</label>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>4) Sichtprüfung außen</h2>
        <p>Pro Position Zustand auswählen und ggf. Bemerkung ergänzen.</p>
      </div>

      <div class="table-scroll">
      <table id="tblExterior">
        <thead>
          <tr>
            <th style="width: 28%;">Bereich</th>
            <th class="status">Zustand</th>
            <th>Bemerkung / Details</th>
            <th style="width: 22%;">Foto(s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <div class="section-title" style="margin-top: 18px;">
        <h2>5) Sichtprüfung innen</h2>
        <p>Innenraum, Sauberkeit, Ausstattung.</p>
      </div>

      <div class="table-scroll">
      <table id="tblInterior">
        <thead>
          <tr>
            <th style="width: 28%;">Bereich</th>
            <th class="status">Zustand</th>
            <th>Bemerkung / Details</th>
            <th style="width: 22%;">Foto(s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>6) Schadensliste (falls Schaden vorhanden)</h2>
        <p>Mindestens 1 Eintrag + Foto, wenn irgendwo "Schaden" gewählt wurde.</p>
      </div>

      <div class="row no-print" style="justify-content:space-between; align-items:flex-start;">
        <button class="btn small" type="button" id="btnAddDamage">+ Schaden hinzufügen</button>
        <span class="muted" style="font-size:12px;">Tipp: Kurze, eindeutige Beschreibung + Größe in cm.</span>
      </div>

      <div class="table-scroll" style="margin-top:10px;">
      <table id="tblDamage">
        <thead>
          <tr>
            <th style="width: 7%;">Nr.</th>
            <th style="width: 20%;">Bereich</th>
            <th>Beschreibung</th>
            <th style="width: 13%;">Größe (cm)</th>
            <th style="width: 22%;">Schadenfoto(s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>7) Pflichtfotos (8x)</h2>
        <p>Ohne diese Fotos kann das Protokoll nicht abgeschlossen werden.</p>
      </div>

      <div class="photo-grid" id="photoGrid">
        <!-- filled by JS -->
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>8) Unterschriften</h2>
        <p>Mitarbeiter-Unterschrift ist Pflicht. Kunde optional.</p>
      </div>

      <div class="sig-wrap">
        <div class="sig">
          <div class="top">
            <div>
              <strong>Mitarbeiter (Pflicht)</strong><br>
              <span class="muted" style="font-size:12px;">Mit Finger/Maus unterschreiben.</span>
            </div>
            <button class="btn small no-print" type="button" id="clearSigEmployee">Löschen</button>
          </div>
          <canvas id="sigEmployee"></canvas>
          <input type="hidden" id="sigEmployeeData">
          <div class="msg muted" style="margin-top:10px;">Mit der Unterschrift bestätigt der Mitarbeiter die Richtigkeit der Angaben.</div>
        </div>

        <div class="sig">
          <div class="top">
            <div>
              <strong>Kunde / Fahrer (optional)</strong><br>
              <span class="muted" style="font-size:12px;">Falls anwesend.</span>
            </div>
            <button class="btn small no-print" type="button" id="clearSigCustomer">Löschen</button>
          </div>
          <canvas id="sigCustomer"></canvas>
          <input type="hidden" id="sigCustomerData">
          <div class="msg muted" style="margin-top:10px;">Optional: Kunde bestätigt den Fahrzeugzustand.</div>
        </div>
      </div>

      <div id="messages" class="msg muted no-print" style="margin-top:14px;">
        Hinweis: Nach dem Ausfüllen kannst du über <b>Senden</b> das Protokoll (HTML + JSON) teilen oder über <b>Druckansicht / PDF</b> eine saubere Protokollseite erstellen.
      </div>
    </div>
  </div>

  
  <script>
    const exteriorRows = [
      "Front (Stoßfänger, Motorhaube, Grill)",
      "Windschutzscheibe / Scheiben",
      "Linke Seite (Tür(en), Schweller)",
      "Rechte Seite (Tür(en), Schweller)",
      "Heck (Stoßfänger, Kofferraumklappe)",
      "Dach",
      "Felgen / Reifen",
      "Beleuchtung (Scheinwerfer/Rücklichter)",
    ];

    const interiorRows = [
      "Cockpit / Armaturen / Display",
      "Lenkrad / Schaltknauf / Bedienelemente",
      "Sitze vorne",
      "Sitze hinten",
      "Teppiche / Fußraum",
      "Kofferraum / Ladefläche",
      "Geruch / Rauchspuren",
      "Sauberkeit allgemein",
    ];

    const photoRequirements = [
      {id:"p_front", title:"Foto 1 - Front", hint:"Frontansicht komplett", required:true},
      {id:"p_rear", title:"Foto 2 - Heck", hint:"Heckansicht komplett", required:true},
      {id:"p_left", title:"Foto 3 - Links", hint:"Linke Seite komplett", required:true},
      {id:"p_right", title:"Foto 4 - Rechts", hint:"Rechte Seite komplett", required:true},
      {id:"p_dashboard", title:"Foto 5 - Cockpit/Display", hint:"Tacho + Tank/Batterie sichtbar", required:true},
      {id:"p_frontinside", title:"Foto 6 - Innen vorne", hint:"Vordersitze + Armaturen", required:true},
      {id:"p_rearinside", title:"Foto 7 - Innen hinten", hint:"Rückbank / Fußraum", required:true},
      {id:"p_trunk", title:"Foto 8 - Kofferraum", hint:"Kofferraum offen", required:true},
    ];

    function setNowDefaults(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      document.getElementById('date').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      document.getElementById('time').value = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function createStatusSelect(name){
      const sel = document.createElement('select');
      sel.name = name;
      sel.innerHTML = `
        <option value="">Bitte auswählen ...</option>
        <option value="OK">OK</option>
        <option value="Schaden">Schaden</option>
        <option value="Nicht geprüft">Nicht geprüft</option>
      `;
      return sel;
    }

    function readFileAsDataURL(file){
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = ()=> reject(new Error("Datei konnte nicht gelesen werden."));
        reader.readAsDataURL(file);
      });
    }

    async function handlePhotoInputChange(inputEl){
      // Pflichtfoto-Inputs (ein Foto + Preview)
      const prev = document.getElementById(inputEl.id + "_prev");
      const img = prev.querySelector('img');
      const hint = prev.querySelector('.hint');

      if(!inputEl.files || inputEl.files.length === 0){
        img.style.display = 'none';
        img.src = '';
        hint.style.display = 'block';
        inputEl.dataset.dataurl = '';
        return;
      }
      const file = inputEl.files[0];
      const dataUrl = await readFileAsDataURL(file);
      inputEl.dataset.dataurl = dataUrl;
      inputEl.dataset.filename = file.name || 'foto.jpg';

      img.src = dataUrl;
      img.style.display = 'block';
      hint.style.display = 'none';
    }

    function safeJsonArray(value){
      try{
        const arr = JSON.parse(value || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function renderThumbs(thumbsEl, hiddenEl){
      const arr = safeJsonArray(hiddenEl.value);
      thumbsEl.innerHTML = "";
      arr.forEach((dataUrl, idx)=>{
        const t = document.createElement('div');
        t.className = "thumb";
        t.innerHTML = `<img src="${dataUrl}" alt="Foto"><button type="button" title="Entfernen">×</button>`;
        t.querySelector('button').addEventListener('click', ()=>{
          const a = safeJsonArray(hiddenEl.value);
          a.splice(idx, 1);
          hiddenEl.value = JSON.stringify(a);
          renderThumbs(thumbsEl, hiddenEl);
        });
        thumbsEl.appendChild(t);
      });
    }

    function createPhotoCollector({buttonText="Foto hinzufügen", hintText="Du kannst mehrere Fotos nacheinander hinzufügen."} = {}){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div class="photo-actions">
          <button class="btn small" type="button" data-add>${buttonText}</button>
          <button class="btn small danger" type="button" data-clear>Fotos löschen</button>
          <input class="file-hidden" type="file" accept="image/*" capture="environment" data-file>
          <input type="hidden" value="[]" data-store>
        </div>
        <div class="thumbs" data-thumbs></div>
        <div class="smallnote">${hintText}</div>
      `;

      const btnAdd = wrap.querySelector('[data-add]');
      const btnClear = wrap.querySelector('[data-clear]');
      const file = wrap.querySelector('[data-file]');
      const store = wrap.querySelector('[data-store]');
      const thumbs = wrap.querySelector('[data-thumbs]');

      btnAdd.addEventListener('click', ()=> file.click());
      btnClear.addEventListener('click', ()=>{
        store.value = "[]";
        file.value = "";
        renderThumbs(thumbs, store);
      });

      file.addEventListener('change', async ()=>{
        if(!file.files || file.files.length === 0) return;
        const f = file.files[0];
        const dataUrl = await readFileAsDataURL(f);

        const arr = safeJsonArray(store.value);
        arr.push(dataUrl);
        store.value = JSON.stringify(arr);

        // allow adding again (also if same file was chosen)
        file.value = "";
        renderThumbs(thumbs, store);
      });

      // initial render
      renderThumbs(thumbs, store);

      // expose store for later reads
      wrap._store = store;
      return wrap;
    }

    function renderInspectionTable(tableId, rows, prefix){
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = "";
      rows.forEach((label, idx)=>{
        const tr = document.createElement('tr');

        const c1 = document.createElement('td');
        c1.textContent = label;

        const c2 = document.createElement('td');
        const sel = createStatusSelect(`${prefix}_${idx}`);
        sel.classList.add('statusSelect');
        c2.appendChild(sel);

        const c3 = document.createElement('td');
        c3.classList.add('note-cell');
        const ta = document.createElement('textarea');
        ta.placeholder = "z.B. Kratzer links, Delle 3cm, Steinschlag ...";
        ta.name = `${prefix}_note_${idx}`;
        c3.appendChild(ta);

        const c4 = document.createElement('td');
        const pc = createPhotoCollector({buttonText:"Foto +", hintText:"Optional. Bei Schaden empfohlen."});
        pc._store.classList.add('insp-photos-data');
        pc._store.name = `${prefix}_photos_${idx}`;
        c4.appendChild(pc);

        tr.appendChild(c1);
        tr.appendChild(c2);
        tr.appendChild(c3);
        tr.appendChild(c4);

        tbody.appendChild(tr);
      });
    }

    function photoCard(req){
      const div = document.createElement('div');
      div.className = 'photo-card';
      div.innerHTML = `
        <div class="meta">
          <div style="min-width:0;">
            <strong>${req.title}${req.required ? " *" : ""}</strong><br>
            <span class="muted" style="font-size:12px;">${req.hint}</span>
          </div>
          <span class="tag ${req.required ? 'ok' : ''}">${req.required ? "Pflicht" : "Optional"}</span>
        </div>
        <input type="file" id="${req.id}" accept="image/*" capture="environment" ${req.required ? "required" : ""}>
        <div class="preview" id="${req.id}_prev">
          <div class="hint">Kein Foto ausgewählt</div>
          <img alt="${req.title}">
        </div>
      `;
      return div;
    }

    let damageCounter = 0;

    function addDamageRow(){
      const tbody = document.querySelector('#tblDamage tbody');
      const nr = tbody.children.length + 1;
      damageCounter += 1;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${nr}</td>
        <td><input type="text" placeholder="z.B. hinten links" class="damage-area"></td>
        <td><textarea placeholder="z.B. Kratzer, Delle, Steinschlag ..." class="damage-desc" style="min-height:44px;"></textarea></td>
        <td><input type="text" placeholder="z.B. 5x2" class="damage-size"></td>
        <td>
          <div data-photo></div>
          <button class="btn small danger no-print" type="button" style="margin-top:8px;" data-remove>Zeile entfernen</button>
        </td>
      `;
      tbody.appendChild(tr);

      const photoCell = tr.querySelector('[data-photo]');
      const pc = createPhotoCollector({buttonText:"Schadenfoto +", hintText:"Mehrere Fotos möglich (mehrfach klicken)."});
      pc._store.classList.add('damage-photos-data');
      photoCell.appendChild(pc);

      tr.querySelector('[data-remove]').addEventListener('click', ()=>{
        tr.remove();
        renumberDamageRows();
      });
    }

    function renumberDamageRows(){
      const rows = document.querySelectorAll('#tblDamage tbody tr');
      rows.forEach((tr, idx)=>{
        tr.children[0].textContent = String(idx+1);
      });
    }

    function anyDamageSelected(){
      const selects = document.querySelectorAll('.statusSelect');
      for(const sel of selects){
        if(sel.value === 'Schaden') return true;
      }
      return false;
    }

    function hasAtLeastOneDamageEntry(){
      const rows = document.querySelectorAll('#tblDamage tbody tr');
      for(const tr of rows){
        const area = tr.querySelector('.damage-area')?.value?.trim() || "";
        const desc = tr.querySelector('.damage-desc')?.value?.trim() || "";
        const size = tr.querySelector('.damage-size')?.value?.trim() || "";
        const store = tr.querySelector('.damage-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        if(area || desc || size || photos.length) return true;
      }
      return false;
    }

    function hasInspectionDamageEvidence(){
      const rows = document.querySelectorAll('#tblExterior tbody tr, #tblInterior tbody tr');
      for(const tr of rows){
        const status = tr.querySelector('select')?.value || "";
        if(status !== "Schaden") continue;
        const note = tr.querySelector('textarea')?.value?.trim() || "";
        const store = tr.querySelector('.insp-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        if(note || photos.length) return true;
      }
      return false;
    }

    function mark(el, bad){
      if(!el) return;
      el.classList.toggle('error', !!bad);
    }

    function showMessage(text, kind){
      const box = document.getElementById('messages');
      box.classList.remove('error','ok');
      if(kind === 'error') box.classList.add('error');
      if(kind === 'ok') box.classList.add('ok');
      box.innerHTML = text;
      box.scrollIntoView({behavior:'smooth', block:'center'});
    }

    function getValue(id){
      return document.getElementById(id).value.trim();
    }

    function getCheckbox(id){
      return document.getElementById(id).checked;
    }

    function validateForm(){
      let ok = true;

      // Pflichtfelder (Stammdaten)
      const requiredIds = ['process','date','time','location','employee','plate','model','mileage','fuel','keys'];
      requiredIds.forEach(id=>{
        const el = document.getElementById(id);
        const bad = !el.value;
        mark(el, bad);
        if(bad) ok = false;
      });

      // Pflichtfotos (8x)
      for(const req of photoRequirements){
        const input = document.getElementById(req.id);
        const bad = req.required && (!input.files || input.files.length === 0);
        mark(input, bad);
        if(bad) ok = false;
      }

      // Mitarbeiter-Unterschrift
      const sigData = document.getElementById('sigEmployeeData').value;
      const sigCanvas = document.getElementById('sigEmployee');
      const badSig = !sigData;
      mark(sigCanvas, badSig);
      if(badSig) ok = false;

      // Wenn irgendwo Schaden gewählt: mind. ein Schadenseintrag ODER Details (Text/Foto) in Zustandsabfrage
      if(anyDamageSelected()){
        if(!hasAtLeastOneDamageEntry() && !hasInspectionDamageEvidence()){
          ok = false;
          showMessage(
            "Es wurde mindestens ein <b>Schaden</b> ausgewählt, aber es fehlen Details. Bitte entweder in der <b>Schadensliste</b> mind. 1 Zeile ausfüllen / Foto hinzufügen <u>oder</u> beim betroffenen Bereich in der <b>Zustandsabfrage</b> Text/Fotos ergänzen.",
            "error"
          );
          return false;
        }
      }

      if(!ok){
        showMessage("Bitte alle rot markierten Pflichtfelder ausfüllen – inkl. Pflichtfotos und Mitarbeiter-Unterschrift.", "error");
        return false;
      }

      showMessage("Alles ok. Du kannst jetzt <b>Senden</b> oder die <b>Druckansicht / PDF</b> öffnen.", "ok");
      return true;
    }

    function fmtDateISOToDE(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      return `${d}.${m}.${y}`;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>\"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    async function buildReportHtml(){
      // ensure Pflichtfotos dataURLs are cached
      for(const req of photoRequirements){
        const input = document.getElementById(req.id);
        if(input && input.files && input.files.length>0 && !input.dataset.dataurl){
          await handlePhotoInputChange(input);
        }
      }

      const data = {
        process: getValue('process'),
        date: fmtDateISOToDE(getValue('date')),
        time: getValue('time'),
        location: getValue('location'),
        company: getValue('company'),
        employee: getValue('employee'),
        customer: getValue('customer'),
        plate: getValue('plate'),
        model: getValue('model'),
        vin: getValue('vin'),
        color: getValue('color'),
        mileage: getValue('mileage'),
        fuel: getValue('fuel'),
        keys: getValue('keys'),
        notesGeneral: getValue('notesGeneral'),
        accessories: {
          warndreieck: getCheckbox('acc_triangle'),
          verbandskasten: getCheckbox('acc_firstaid'),
          warnweste: getCheckbox('acc_vest'),
          papiere: getCheckbox('acc_docs'),
          ladekabel: getCheckbox('acc_charging'),
          pannenset: getCheckbox('acc_spare'),
          bordwerkzeug: getCheckbox('acc_tools'),
        },
        exterior: [],
        interior: [],
        damage: [],
        photos: [],
        signatures: {
          employee: document.getElementById('sigEmployeeData').value,
          customer: document.getElementById('sigCustomerData').value
        }
      };

      // Inspection tables
      const extRows = document.querySelectorAll('#tblExterior tbody tr');
      extRows.forEach((tr)=>{
        const area = tr.children[0].textContent;
        const status = tr.querySelector('select')?.value || "";
        const note = tr.querySelector('textarea')?.value || "";
        const store = tr.querySelector('.insp-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        data.exterior.push({area, status, note, photos});
      });

      const intRows = document.querySelectorAll('#tblInterior tbody tr');
      intRows.forEach((tr)=>{
        const area = tr.children[0].textContent;
        const status = tr.querySelector('select')?.value || "";
        const note = tr.querySelector('textarea')?.value || "";
        const store = tr.querySelector('.insp-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        data.interior.push({area, status, note, photos});
      });

      // Damage table
      const dmgRows = document.querySelectorAll('#tblDamage tbody tr');
      dmgRows.forEach((tr)=>{
        const area = tr.querySelector('.damage-area')?.value?.trim() || "";
        const desc = tr.querySelector('.damage-desc')?.value?.trim() || "";
        const size = tr.querySelector('.damage-size')?.value?.trim() || "";
        const store = tr.querySelector('.damage-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        if(area || desc || size || photos.length){
          data.damage.push({area, desc, size, photos});
        }
      });

      // Pflichtfotos
      for(const req of photoRequirements){
        const input = document.getElementById(req.id);
        const dataUrl = input.dataset.dataurl || "";
        data.photos.push({title:req.title, hint:req.hint, dataUrl});
      }

      const accList = [];
      if(data.accessories.warndreieck) accList.push("Warndreieck");
      if(data.accessories.verbandskasten) accList.push("Verbandskasten");
      if(data.accessories.warnweste) accList.push("Warnweste(n)");
      if(data.accessories.papiere) accList.push("Zulassung/Papiere");
      if(data.accessories.ladekabel) accList.push("Lade-/Kabel");
      if(data.accessories.pannenset) accList.push("Reserverad/Pannenset");
      if(data.accessories.bordwerkzeug) accList.push("Bordwerkzeug");
      const accText = accList.length ? accList.join(", ") : "Keine Angaben";

      const photosToThumbs = (arr)=>{
        if(!arr || !arr.length) return `<span style="color:#555;">-</span>`;
        return `<div class="thumbs-print">${arr.map(p=>`<img src="${p}" alt="Foto">`).join("")}</div>`;
      };

      const rowsToHtml = (arr)=> arr.map(r=>`
        <tr>
          <td>${escapeHtml(r.area)}</td>
          <td>${escapeHtml(r.status)}</td>
          <td>${escapeHtml(r.note)}</td>
          <td>${photosToThumbs(r.photos)}</td>
        </tr>
      `).join("");

      const damageToHtml = (arr)=> {
        if(!arr.length) return `<p style="margin:0; color:#444;">Keine Schadenangaben.</p>`;
        return `
          <table>
            <thead>
              <tr>
                <th style="width:18%;">Bereich</th>
                <th>Beschreibung</th>
                <th style="width:14%;">Größe</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(d=>`
                <tr>
                  <td>${escapeHtml(d.area)}</td>
                  <td>${escapeHtml(d.desc)}</td>
                  <td>${escapeHtml(d.size)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
          ${arr.some(d=>d.photos && d.photos.length) ? `
            <div style="margin-top:10px; display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
              ${arr.flatMap(d=> (d.photos||[]).map(p=>`<img src="${p}" alt="Schadenfoto" style="width:100%; height:120px; object-fit:cover; border:1px solid #ccc; border-radius:10px;">`)).join("")}
            </div>
          ` : ``}
        `;
      };

      const photoGridHtml = data.photos.map(p=>`
        <div style="border:1px solid #ddd; border-radius:12px; padding:10px;">
          <div style="font-weight:700; font-size:12px;">${escapeHtml(p.title)}</div>
          <div style="color:#555; font-size:11px; margin-bottom:6px;">${escapeHtml(p.hint)}</div>
          <img src="${p.dataUrl}" alt="${escapeHtml(p.title)}" style="width:100%; height:180px; object-fit:cover; border:1px solid #ccc; border-radius:10px;">
        </div>
      `).join("");

      const sigEmployeeHtml = data.signatures.employee
        ? `<img src="${data.signatures.employee}" alt="Unterschrift Mitarbeiter" style="width:100%; height:120px; object-fit:contain; border:1px solid #ccc; border-radius:10px;">`
        : `<div style="color:#b00;">Fehlt</div>`;

      const sigCustomerHtml = data.signatures.customer
        ? `<img src="${data.signatures.customer}" alt="Unterschrift Kunde" style="width:100%; height:120px; object-fit:contain; border:1px solid #ccc; border-radius:10px;">`
        : `<div style="color:#555;">Keine</div>`;

      const html = `
      <!doctype html>
      <html lang="de">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Fahrzeugzustandsprotokoll - ${escapeHtml(data.plate)}</title>
        <style>
          body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 18px; color:#111; }
          h1{ margin:0 0 6px; font-size: 18px; }
          .sub{ color:#444; font-size: 12px; margin-bottom: 12px; }
          .box{ border:1px solid #ddd; border-radius:12px; padding: 12px; margin-bottom: 12px; }
          .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; }
          .kv{ font-size: 12px; }
          .k{ color:#555; font-size: 11px; }
          .v{ font-weight: 650; }
          table{ width:100%; border-collapse: collapse; border:1px solid #ddd; border-radius:12px; overflow:hidden; }
          th,td{ border-bottom:1px solid #eee; padding:8px; font-size: 12px; vertical-align: top; }
          th{ background:#f6f6f6; text-align:left; }
          tr:last-child td{ border-bottom:none; }
          .photo-grid{ display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; }
          @media (max-width: 900px){ .photo-grid{ grid-template-columns: repeat(2, 1fr);} }
          .thumbs-print{ display:flex; flex-wrap:wrap; gap:6px; }
          .thumbs-print img{ width:56px; height:56px; object-fit:cover; border:1px solid #ccc; border-radius:10px; }
          .no-print{ margin-bottom: 12px; }
          .btn{ border:1px solid #ddd; background:#fff; padding: 10px 12px; border-radius: 12px; font-weight: 650; cursor:pointer; }
          @media print{ .no-print{ display:none; } body{ margin:0; } }
        </style>
      </head>
      <body>
        <div class="no-print">
          <button class="btn" onclick="window.print()">Drucken / als PDF speichern</button>
        </div>

        <h1>Fahrzeugzustandsprotokoll (${escapeHtml(data.process)})</h1>
        <div class="sub">Datum ${escapeHtml(data.date)} um ${escapeHtml(data.time)} - Standort: ${escapeHtml(data.location)}</div>

        <div class="box">
          <div class="grid">
            <div class="kv" style="grid-column: span 6;"><div class="k">Unternehmen</div><div class="v">${escapeHtml(data.company || "-")}</div></div>
            <div class="kv" style="grid-column: span 6;"><div class="k">Mitarbeiter</div><div class="v">${escapeHtml(data.employee)}</div></div>

            <div class="kv" style="grid-column: span 4;"><div class="k">Kunde/Fahrer</div><div class="v">${escapeHtml(data.customer || "-")}</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Kennzeichen</div><div class="v">${escapeHtml(data.plate)}</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Marke/Modell</div><div class="v">${escapeHtml(data.model)}</div></div>

            <div class="kv" style="grid-column: span 4;"><div class="k">FIN/VIN</div><div class="v">${escapeHtml(data.vin || "-")}</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Farbe</div><div class="v">${escapeHtml(data.color || "-")}</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Schlüssel</div><div class="v">${escapeHtml(data.keys)}</div></div>

            <div class="kv" style="grid-column: span 4;"><div class="k">Kilometerstand</div><div class="v">${escapeHtml(data.mileage)} km</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Tank/Batterie</div><div class="v">${escapeHtml(data.fuel)} %</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Zubehör/Dokumente</div><div class="v">${escapeHtml(accText)}</div></div>

            <div class="kv" style="grid-column: span 12;"><div class="k">Bemerkungen</div><div class="v" style="font-weight:500;">${escapeHtml(data.notesGeneral || "-")}</div></div>
          </div>
        </div>

        <div class="box">
          <div style="font-weight:800; margin-bottom:8px;">Sichtprüfung außen</div>
          <table>
            <thead><tr><th style="width:28%;">Bereich</th><th style="width:14%;">Zustand</th><th>Bemerkung</th><th style="width:22%;">Foto(s)</th></tr></thead>
            <tbody>${rowsToHtml(data.exterior)}</tbody>
          </table>
        </div>

        <div class="box">
          <div style="font-weight:800; margin-bottom:8px;">Sichtprüfung innen</div>
          <table>
            <thead><tr><th style="width:28%;">Bereich</th><th style="width:14%;">Zustand</th><th>Bemerkung</th><th style="width:22%;">Foto(s)</th></tr></thead>
            <tbody>${rowsToHtml(data.interior)}</tbody>
          </table>
        </div>

        <div class="box">
          <div style="font-weight:800; margin-bottom:8px;">Schadensliste</div>
          ${damageToHtml(data.damage)}
        </div>

        <div class="box">
          <div style="font-weight:800; margin-bottom:8px;">Pflichtfotos</div>
          <div class="photo-grid">${photoGridHtml}</div>
        </div>

        <div class="box">
          <div style="font-weight:800; margin-bottom:8px;">Unterschriften</div>
          <div class="grid">
            <div style="grid-column: span 6;">
              <div class="k">Mitarbeiter</div>
              ${sigEmployeeHtml}
            </div>
            <div style="grid-column: span 6;">
              <div class="k">Kunde/Fahrer (optional)</div>
              ${sigCustomerHtml}
            </div>
          </div>
        </div>

        <div class="sub">Erstellt mit dem interaktiven Fahrzeugzustandsprotokoll.</div>
      </body>
      </html>
      `;
      return { html, data };
    }

    function downloadFile(filename, content, mime){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 2500);
    }

    async function exportJson(){
      const { data } = await buildReportHtml();
      const json = JSON.stringify(data, null, 2);
      const safePlate = (data.plate || "fahrzeug").replace(/[^a-z0-9\-]+/gi,'_');
      downloadFile(`fahrzeugprotokoll_${safePlate}_${(data.date||'').replace(/\./g,'-')}.json`, json, "application/json");
      showMessage("JSON Export erstellt (Download sollte gestartet sein).", "ok");
    }

    async function openPrintView(){
      const { html } = await buildReportHtml();
      const w = window.open("", "_blank");
      if(!w){
        showMessage("Pop-up blockiert. Bitte Pop-ups erlauben oder manuell drucken.", "error");
        return;
      }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
    }

    async function sendProtocol(){
      if(!validateForm()) return;

      const { html, data } = await buildReportHtml();
      const json = JSON.stringify(data, null, 2);

      const safePlate = (data.plate || "fahrzeug").replace(/[^a-z0-9\-]+/gi,'_');
      const baseName = `fahrzeugprotokoll_${safePlate}_${(data.date||'').replace(/\./g,'-')}`;

      const htmlFile = new File([html], `${baseName}.html`, {type: "text/html"});
      const jsonFile = new File([json], `${baseName}.json`, {type: "application/json"});
      const shareText = `${data.process} – ${data.plate} – ${data.date} ${data.time} (${data.location})`;

      // Preferred: native share sheet (mobile)
      if(navigator.share){
        try{
          if(!navigator.canShare || navigator.canShare({files:[htmlFile, jsonFile]})){
            await navigator.share({
              title: "Fahrzeugzustandsprotokoll",
              text: shareText,
              files: [htmlFile, jsonFile]
            });
            showMessage("Senden/Teilen wurde gestartet (Share-Menü).", "ok");
            return;
          }
        }catch(err){
          // fall back to download
          console.warn("Share failed:", err);
        }
      }

      // Fallback: download files + open mail client
      downloadFile(`${baseName}.html`, html, "text/html");
      downloadFile(`${baseName}.json`, json, "application/json");

      try{
        const subject = encodeURIComponent(`Fahrzeugzustandsprotokoll ${data.plate}`);
        const body = encodeURIComponent(
          `Hallo,\n\nanbei das Fahrzeugzustandsprotokoll.\n\n${shareText}\n\nHinweis: Der Browser hat HTML-Report + JSON heruntergeladen. Bitte als Anhang hinzufügen.\n`
        );
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      }catch(e){}

      showMessage("Teilen wird von diesem Browser nicht unterstützt. Es wurden stattdessen <b>HTML-Report</b> + <b>JSON</b> heruntergeladen (zum manuellen Versenden/Upload).", "ok");
    }

    // Signature pads (simple, no external libs)
    function setupSignaturePad(canvasId, hiddenId, clearBtnId){
      const canvas = document.getElementById(canvasId);
      const hidden = document.getElementById(hiddenId);
      const clearBtn = document.getElementById(clearBtnId);

      let drawing = false;
      let hasInk = false;
      let last = {x:0, y:0};

      function resize(){
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * ratio);
        canvas.height = Math.floor(rect.height * ratio);
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 2.2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'rgba(233,238,252,.95)';

        if(hasInk){
          const imgData = hidden.value;
          if(imgData){
            const img = new Image();
            img.onload = ()=> ctx.drawImage(img, 0, 0, rect.width, rect.height);
            img.src = imgData;
          }else{
            ctx.clearRect(0,0,rect.width, rect.height);
          }
        }else{
          ctx.clearRect(0,0,rect.width, rect.height);
        }
      }

      function pos(evt){
        const rect = canvas.getBoundingClientRect();
        return {
          x: (evt.clientX - rect.left),
          y: (evt.clientY - rect.top)
        };
      }

      function start(evt){
        drawing = true;
        const p = pos(evt);
        last = p;
      }

      function move(evt){
        if(!drawing) return;
        const ctx = canvas.getContext('2d');
        const p = pos(evt);
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        last = p;
        hasInk = true;
        hidden.value = canvas.toDataURL("image/png");
      }

      function end(){
        drawing = false;
        if(hasInk){
          hidden.value = canvas.toDataURL("image/png");
        }
      }

      function clear(){
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        hasInk = false;
        hidden.value = "";
      }

      canvas.addEventListener('pointerdown', (e)=>{ canvas.setPointerCapture(e.pointerId); start(e); });
      canvas.addEventListener('pointermove', (e)=> move(e));
      canvas.addEventListener('pointerup', ()=> end());
      canvas.addEventListener('pointercancel', ()=> end());
      clearBtn.addEventListener('click', clear);
      window.addEventListener('resize', resize);

      resize();
      return { clear, get hasInk(){ return hasInk; } };
    }

    function init(){
      setNowDefaults();

      renderInspectionTable("tblExterior", exteriorRows, "ext");
      renderInspectionTable("tblInterior", interiorRows, "int");

      // Damage table - start with one row
      addDamageRow();
      document.getElementById('btnAddDamage').addEventListener('click', addDamageRow);

      // Pflichtfotos
      const grid = document.getElementById('photoGrid');
      photoRequirements.forEach(req=>{
        const card = photoCard(req);
        grid.appendChild(card);
      });

      photoRequirements.forEach(req=>{
        const input = document.getElementById(req.id);
        input.addEventListener('change', ()=> handlePhotoInputChange(input));
      });

      // Signatures
      setupSignaturePad('sigEmployee','sigEmployeeData','clearSigEmployee');
      setupSignaturePad('sigCustomer','sigCustomerData','clearSigCustomer');

      // Buttons
      document.getElementById('btnSend').addEventListener('click', async ()=>{
        await sendProtocol();
      });

      document.getElementById('btnPrint').addEventListener('click', async ()=>{
        if(!validateForm()) return;
        await openPrintView();
      });

      document.getElementById('btnExportJson').addEventListener('click', async ()=>{
        if(!validateForm()) return;
        await exportJson();
      });

      document.getElementById('btnReset').addEventListener('click', ()=>{
        if(!confirm("Wirklich alles zurücksetzen?")) return;
        location.reload();
      });

      showMessage("Fülle das Protokoll aus. Danach kannst du es <b>Senden</b> oder die <b>Druckansicht / PDF</b> öffnen.", "ok");
    }

    init();
  </script>

</body>
</html>
