<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fahrzeugzustandsprotokoll</title>
  <style>
    :root{
      --bg:#f3f4f6;
      --card:#ffffff;
      --ink:#1f2937;
      --muted:#6b7280;
      --line:rgba(0,0,0,.1);
      --accent:#c8102e;
      --danger:#ef4444;
      --ok:#10b981;
      --warning:#f59e0b;
      --input-bg:#ffffff;
      --table-header:#f9fafb;
      --hover-bg:#f9fafb;
    }
    body.dark{
      --bg:#1a1a1a;
      --card:#242424;
      --ink:#f5f5f5;
      --muted:#a0a0a0;
      --line:rgba(255,255,255,.12);
      --input-bg:#2a2a2a;
      --table-header:#2a2a2a;
      --hover-bg:#2a2a2a;
    }
    body.dark select{
      color-scheme: dark;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color:var(--ink);
    }
    .wrap{
      max-width:1100px;
      margin: 24px auto 64px;
      padding: 0 16px;
    }
    header{
      display:flex;
      gap:16px;
      align-items:flex-start;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .title h1{
      margin:0;
      font-size: 26px;
      letter-spacing:.2px;
      color: var(--accent);
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      line-height:1.35;
      max-width:70ch;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: var(--card);
      color:var(--muted);
      font-size: 12px;
      white-space:nowrap;
      box-shadow: 0 1px 3px rgba(0,0,0,.1);
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,.1), 0 2px 4px -1px rgba(0,0,0,.06);
    }
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .field label{
      font-size: 12px;
      color:var(--muted);
    }
    input[type="text"], input[type="number"], input[type="date"], input[type="time"], input[type="email"], select, textarea{
      width:100%;
      background: var(--input-bg);
      border:2px solid var(--line);
      color:var(--ink);
      border-radius: 10px;
      padding:10px 12px;
      outline:none;
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    }
    /* Fix dropdown readability */
    select{
      color-scheme: light;
      background-color: var(--input-bg);
    }
    select option{
      background-color: var(--input-bg);
      color: var(--ink);
      padding: 10px;
    }
    textarea{ min-height: 70px; resize: vertical; }
    input::placeholder, textarea::placeholder{ color: rgba(233,238,252,.45); }
    input:focus, select:focus, textarea:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(200,16,46,.15);
    }
    input::placeholder, textarea::placeholder{
      color: #9ca3af;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: var(--card);
      color: var(--ink);
      padding: 10px 14px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      transition: all 0.2s;
      box-shadow: 0 1px 2px rgba(0,0,0,.05);
    }
    .btn:hover{ border-color: var(--accent); color: var(--accent); }
    .btn.icon{
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btn.primary{
      background: linear-gradient(180deg, #dc2626, #b91c1c);
      border-color: #b91c1c;
      color: #fff;
    }
    .btn.primary:hover{
      background: linear-gradient(180deg, #b91c1c, #991b1b);
    }
    .btn.danger{
      background: #fef2f2;
      border-color: #fecaca;
      color: #dc2626;
    }
    .btn.danger:hover{
      background: #fee2e2;
      border-color: #f87171;
    }
    .btn.small{ padding: 7px 10px; border-radius: 10px; font-size: 12px; }
    .section-title{
      margin: 18px 0 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }
    .section-title h2{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .section-title p{
      margin:0;
      color:var(--muted);
      font-size: 12px;
    }
    .divider{
      height:1px;
      background: var(--line);
      margin: 14px 0;
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
    }
    th, td{
      padding:10px;
      border-bottom:1px solid var(--line);
      vertical-align:top;
    }
    th{
      font-size: 12px;
      color: var(--muted);
      text-align:left;
      background: var(--table-header);
      font-weight: 600;
    }
    tr:last-child td{ border-bottom:none; }
    tr:hover{ background: var(--hover-bg); }
    .status{
      width: 150px;
    }
    .note-cell textarea{ min-height: 44px; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid var(--line);
      color: var(--muted);
      background: var(--table-header);
    }
    .tag.ok{ border-color: #86efac; color: #16a34a; background: #f0fdf4; }
    .tag.bad{ border-color: #fca5a5; color: #dc2626; background: #fef2f2; }

    .photo-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .photo-grid{ grid-template-columns: repeat(2, 1fr); }
      header{ flex-direction:column; align-items:flex-start; }
    }
    .photo-card{
      border: 1px dashed var(--line);
      border-radius: 14px;
      padding: 12px;
      background: var(--table-header);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-width:0;
    }
    .photo-card .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .photo-card .meta strong{
      font-size: 13px;
      line-height:1.2;
    }
    .photo-card .meta span{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .photo-card input[type="file"]{
      width:100%;
      padding:10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--input-bg);
      color: var(--muted);
    }
    .preview{
      width:100%;
      aspect-ratio: 4 / 3;
      border-radius: 12px;
      border:1px solid var(--line);
      background: var(--card);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .preview img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:none;
    }
    .preview .hint{
      color: rgba(233,238,252,.55);
      font-size: 12px;
      padding: 10px;
      text-align:center;
    }

    .sig-wrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .sig-wrap{ grid-template-columns: 1fr; }
    }
    .sig{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      background: var(--table-header);
    }
    .sig .top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:8px;
    }
    canvas{
      width:100%;
      height: 180px;
      border-radius: 12px;
      border:1px dashed var(--line);
      background: var(--card);
      touch-action: none;
    }

    .error{
      border-color: #f87171 !important;
      box-shadow: 0 0 0 3px rgba(239,68,68,.15) !important;
    }
    .msg{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: var(--table-header);
      color: var(--muted);
    }
    .msg.error{
      border-color: #fca5a5;
      color: #dc2626;
      background: #fef2f2;
      box-shadow: none !important;
    }
    .msg.ok{
      border-color: #86efac;
      color: #16a34a;
      background: #f0fdf4;
    }
    .muted{ color: var(--muted); }

    /* Better mobile editing + responsive tables */
    .table-scroll{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border-radius: 12px;
    }
    .table-scroll table{
      min-width: 820px;
    }
    
    /* Mobile-friendly stacked table layout */
    @media (max-width: 768px){
      .table-scroll{
        overflow-x: visible;
      }
      .table-scroll table{
        min-width: 0;
        border: none;
        background: transparent;
      }
      .table-scroll table thead{
        display: none;
      }
      .table-scroll table tbody tr{
        display: block;
        border: 1px solid var(--line);
        border-radius: 14px;
        margin-bottom: 12px;
        padding: 14px;
        background: var(--card);
        border: 1px solid var(--line);
      }
      .table-scroll table tbody td{
        display: block;
        border: none;
        padding: 8px 0;
      }
      .table-scroll table tbody td:first-child{
        font-weight: 600;
        font-size: 14px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--line);
        margin-bottom: 8px;
      }
      .table-scroll table tbody td:not(:first-child):before{
        content: attr(data-title);
        display: block;
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 4px;
      }
      .table-scroll table tbody td select,
      .table-scroll table tbody td textarea{
        width: 100%;
      }
      .note-cell textarea{
        min-height: 60px;
      }
      
      /* Grid adjustments */
      .grid{
        grid-template-columns: 1fr !important;
      }
      .grid > .field{
        grid-column: span 1 !important;
      }
      
      /* Section title */
      .section-title{
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      
      /* Buttons */
      .row{
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      .row .btn{
        width: 100%;
        text-align: center;
      }
      
      /* Hide mobile cards container (using CSS table approach instead) */
      .mobile-cards{
        display: none;
      }
    }
    
    @media (max-width: 520px){
      input[type="text"], input[type="number"], input[type="date"], input[type="time"], select, textarea{
        font-size: 16px; /* prevents iOS zoom + improves typing */
      }
      .wrap{
        padding: 0 12px;
      }
      .card{
        padding: 12px;
      }
      .title h1{
        font-size: 20px;
      }
      .pill{
        display: none;
      }
    }

    /* Inline photo collector (for Schäden + Zustandsabfrage) */
    .photo-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      align-items:center;
    }
    .file-hidden{ display:none; }
    .thumbs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .thumb{
      position:relative;
      width:44px;
      height:44px;
      flex: 0 0 auto;
    }
    .thumb img{
      width:44px;
      height:44px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid rgba(233,238,252,.18);
    }
    .thumb button{
      position:absolute;
      top:-6px;
      right:-6px;
      width:18px;
      height:18px;
      border-radius:999px;
      border:1px solid rgba(233,238,252,.25);
      background: rgba(0,0,0,.55);
      color: var(--ink);
      cursor:pointer;
      font-size:12px;
      line-height:16px;
      padding:0;
    }
    .smallnote{
      color: var(--muted);
      font-size: 11px;
      margin-top: 6px;
      line-height: 1.25;
    }


    /* Print */
    @media print{
      body{ background:#fff; color:#000; }
      .wrap{ max-width:none; margin:0; padding:0; }
      .card{ box-shadow:none; background:#fff; border-color:#ddd; }
      header, .no-print{ display:none !important; }
      input, select, textarea{
        border-color:#bbb !important;
        background:#fff !important;
        color:#000 !important;
        box-shadow:none !important;
      }
      table{ border-color:#bbb; }
      th{ color:#000; background:#f3f3f3; }
      .preview{ border-color:#bbb; background:#fff; }
      canvas{ display:none; }
      .sig img{ display:block !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:16px;">
        <img src="almas-logo-small.jpg" alt="ALMAS INDUSTRIES" style="height:48px; border-radius:8px;">
        <div class="title">
          <h1 style="color:var(--accent);">Fahrzeugzustandsprotokoll</h1>
          <p>
            Digitales Protokoll zur Fahrzeug-Übergabe/Rückgabe inklusive Pflichtfotos.
          </p>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:10px;">
        <button class="btn icon" id="btnDarkMode" title="Dark Mode umschalten" type="button">
          <svg id="iconSun" width="20" height="20" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/></svg>
          <svg id="iconMoon" width="20" height="20" fill="currentColor" viewBox="0 0 20 20" style="display:none;"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"/></svg>
        </button>
        <div class="pill" style="display:none;">Tipp: Fotos direkt mit Kamera</div>
      </div>
    </header>

    <div class="card">
      <div class="row no-print" style="justify-content:space-between; gap:12px;">
        <div class="row" style="gap:8px;">
          <button class="btn primary" id="btnSend" type="button">Senden</button>
          <button class="btn" id="btnPrint" type="button">Druckansicht / PDF</button>
          <button class="btn" id="btnReset" type="button">Alles zurücksetzen</button>
        </div>
        <span class="muted" style="font-size:12px;">Version 1.1 - Sendefunktion + Fotos in Zustand/Schaden</span>
      </div>

      <div id="messages" class="msg muted no-print" style="margin-top:12px; margin-bottom:12px;"></div>

      <div class="section-title">
        <h2>1) Allgemeine Angaben</h2>
        <p>Pflichtfelder sind mit * markiert.</p>
      </div>

      <div class="grid">
        <div class="field" style="grid-column: span 3;">
          <label for="process">Vorgang *</label>
          <select id="process">
            <option value="">Bitte auswählen ...</option>
            <option>Übergabe</option>
            <option>Rückgabe</option>
            <option>Zwischenkontrolle</option>
          </select>
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="date">Datum *</label>
          <input id="date" type="date">
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="time">Uhrzeit *</label>
          <input id="time" type="time">
        </div>
        <div class="field" style="grid-column: span 3;">
          <label for="location">Standort / Filiale *</label>
          <input id="location" type="text" placeholder="z.B. Berlin Mitte">
        </div>

        <div class="field" style="grid-column: span 6;">
          <label for="employee">Mitarbeiter *</label>
          <input id="employee" type="text" placeholder="Vorname Nachname">
        </div>
        <div class="field" style="grid-column: span 6;">
          <label for="employeeEmail">E-Mail Mitarbeiter</label>
          <input id="employeeEmail" type="email" placeholder="vorname.nachname@almas-industries.de">
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>2) Fahrzeugdaten</h2>
        <p>Bitte Daten vom Fahrzeugschein/Display übernehmen.</p>
      </div>

      <div class="grid">
        <div class="field" style="grid-column: span 3;">
          <label for="plate">Kennzeichen *</label>
          <input id="plate" type="text" placeholder="z.B. B-AB 1234">
        </div>
        <div class="field" style="grid-column: span 5;">
          <label for="model">Marke / Modell *</label>
          <input id="model" type="text" placeholder="z.B. VW Golf">
        </div>
        <div class="field" style="grid-column: span 4;">
          <label for="mileage">Kilometerstand (km) *</label>
          <input id="mileage" type="number" min="0" step="1" placeholder="z.B. 54210">
        </div>

        <div class="field" style="grid-column: span 12;">
          <label for="notesGeneral">Bemerkungen (optional)</label>
          <textarea id="notesGeneral" placeholder="z.B. Hinweis auf Vorschaden, Winterreifen, Besonderheiten ..."></textarea>
        </div>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>3) Sichtprüfung außen</h2>
        <p>Pro Position Zustand auswählen und ggf. Bemerkung ergänzen.</p>
      </div>

      <div class="table-scroll">
      <table id="tblExterior">
        <thead>
          <tr>
            <th style="width: 28%;">Bereich</th>
            <th class="status">Zustand</th>
            <th>Bemerkung / Details</th>
            <th style="width: 22%;">Foto(s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <div class="section-title" style="margin-top: 18px;">
        <h2>4) Sichtprüfung innen</h2>
        <p>Innenraum, Sauberkeit, Ausstattung.</p>
      </div>

      <div class="table-scroll">
      <table id="tblInterior">
        <thead>
          <tr>
            <th style="width: 28%;">Bereich</th>
            <th class="status">Zustand</th>
            <th>Bemerkung / Details</th>
            <th style="width: 22%;">Foto(s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>5) Schadensliste (falls Schaden vorhanden)</h2>
        <p>Mindestens 1 Eintrag + Foto, wenn irgendwo "Schaden" gewählt wurde.</p>
      </div>

      <div class="row no-print" style="justify-content:space-between; align-items:flex-start;">
        <button class="btn small" type="button" id="btnAddDamage">+ Schaden hinzufügen</button>
        <span class="muted" style="font-size:12px;">Tipp: Kurze, eindeutige Beschreibung + Größe in cm.</span>
      </div>

      <div class="table-scroll" style="margin-top:10px;">
      <table id="tblDamage">
        <thead>
          <tr>
            <th style="width: 7%;">Nr.</th>
            <th style="width: 20%;">Bereich</th>
            <th>Beschreibung</th>
            <th style="width: 13%;">Größe (cm)</th>
            <th style="width: 22%;">Schadenfoto(s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>6) Pflichtfotos (8x)</h2>
        <p>Ohne diese Fotos kann das Protokoll nicht abgeschlossen werden.</p>
      </div>

      <div class="photo-grid" id="photoGrid">
        <!-- filled by JS -->
      </div>

      <div class="divider"></div>

      <div class="section-title">
        <h2>7) Unterschrift</h2>
        <p>Bitte unterschreiben zur Bestätigung.</p>
      </div>

      <div class="sig-wrap">
        <div class="sig">
          <div class="top">
            <div>
              <strong>Mitarbeiter (Pflicht)</strong><br>
              <span class="muted" style="font-size:12px;">Mit Finger/Maus unterschreiben.</span>
            </div>
            <button class="btn small no-print" type="button" id="clearSigEmployee">Löschen</button>
          </div>
          <canvas id="sigEmployee"></canvas>
          <input type="hidden" id="sigEmployeeData">
          <div class="msg muted" style="margin-top:10px;">Mit der Unterschrift bestätigt der Mitarbeiter die Richtigkeit der Angaben.</div>
        </div>
      </div>

    </div>
  </div>

  
  <script>
    const exteriorRows = [
      "Front (Stoßfänger, Motorhaube, Grill)",
      "Windschutzscheibe / Scheiben",
      "Linke Seite (Tür(en), Schweller)",
      "Rechte Seite (Tür(en), Schweller)",
      "Heck (Stoßfänger, Kofferraumklappe)",
      "Felgen / Reifen",
    ];

    const interiorRows = [
      "Cockpit / Armaturen / Display",
      "Sitze vorne",
      "Sitze hinten",
      "Teppiche / Fußraum",
      "Kofferraum / Ladefläche",
      "Geruch / Rauchspuren",
    ];

    const photoRequirements = [
      {id:"p_front", title:"Foto 1 - Front", hint:"Frontansicht komplett", required:false},
      {id:"p_rear", title:"Foto 2 - Heck", hint:"Heckansicht komplett", required:false},
      {id:"p_left", title:"Foto 3 - Links", hint:"Linke Seite komplett", required:false},
      {id:"p_right", title:"Foto 4 - Rechts", hint:"Rechte Seite komplett", required:false},
      {id:"p_dashboard", title:"Foto 5 - Cockpit/Display", hint:"Tacho + Kilometerstand sichtbar", required:false},
      {id:"p_frontinside", title:"Foto 6 - Innen vorne", hint:"Vordersitze + Armaturen", required:false},
      {id:"p_rearinside", title:"Foto 7 - Innen hinten", hint:"Rückbank / Fußraum", required:false},
      {id:"p_trunk", title:"Foto 8 - Kofferraum", hint:"Kofferraum offen", required:false},
    ];

    function setNowDefaults(){
      const d = new Date();
      const pad = (n)=> String(n).padStart(2,'0');
      document.getElementById('date').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      document.getElementById('time').value = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function createStatusSelect(name){
      const sel = document.createElement('select');
      sel.name = name;
      sel.innerHTML = `
        <option value="">Bitte auswählen ...</option>
        <option value="OK">OK</option>
        <option value="Schaden">Schaden</option>
      `;
      return sel;
    }

    function createInteriorStatusCheckboxes(name){
      const wrap = document.createElement('div');
      wrap.className = 'interior-status-wrap';
      wrap.innerHTML = `
        <label style="display:flex; align-items:center; gap:6px; margin-bottom:4px; cursor:pointer;">
          <input type="checkbox" name="${name}_ok" value="OK" class="interior-ok"> OK
        </label>
        <label style="display:flex; align-items:center; gap:6px; margin-bottom:4px; cursor:pointer;">
          <input type="checkbox" name="${name}_verschmutzt" value="Verschmutzt" class="interior-extra"> Verschmutzt
        </label>
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" name="${name}_beschaedigt" value="Beschädigt" class="interior-extra"> Beschädigt
        </label>
      `;
      return wrap;
    }

    // Komprimiert Bilder auf max. 1600px Breite und 75% JPEG-Qualität
    function compressImage(file, maxWidth = 1600, quality = 0.75){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("Datei konnte nicht gelesen werden."));
        reader.onload = (e) => {
          const img = new Image();
          img.onerror = () => reject(new Error("Bild konnte nicht geladen werden."));
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            
            // Nur verkleinern wenn nötig
            if (width > maxWidth) {
              height = Math.round(height * maxWidth / width);
              width = maxWidth;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            // Als JPEG mit Kompression ausgeben
            const dataUrl = canvas.toDataURL('image/jpeg', quality);
            resolve(dataUrl);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function readFileAsDataURL(file){
      // Nutze Kompression für Bilder
      if (file.type && file.type.startsWith('image/')) {
        return compressImage(file, 1600, 0.75);
      }
      // Fallback für andere Dateien
      return new Promise((resolve, reject)=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.onerror = ()=> reject(new Error("Datei konnte nicht gelesen werden."));
        reader.readAsDataURL(file);
      });
    }

    async function handlePhotoInputChange(inputEl){
      // Pflichtfoto-Inputs (ein Foto + Preview)
      const prev = document.getElementById(inputEl.id + "_prev");
      const img = prev.querySelector('img');
      const hint = prev.querySelector('.hint');

      if(!inputEl.files || inputEl.files.length === 0){
        img.style.display = 'none';
        img.src = '';
        hint.style.display = 'block';
        inputEl.dataset.dataurl = '';
        return;
      }
      const file = inputEl.files[0];
      const dataUrl = await readFileAsDataURL(file);
      inputEl.dataset.dataurl = dataUrl;
      inputEl.dataset.filename = file.name || 'foto.jpg';

      img.src = dataUrl;
      img.style.display = 'block';
      hint.style.display = 'none';
    }

    function safeJsonArray(value){
      try{
        const arr = JSON.parse(value || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch(e){
        return [];
      }
    }

    function renderThumbs(thumbsEl, hiddenEl){
      const arr = safeJsonArray(hiddenEl.value);
      thumbsEl.innerHTML = "";
      arr.forEach((dataUrl, idx)=>{
        const t = document.createElement('div');
        t.className = "thumb";
        t.innerHTML = `<img src="${dataUrl}" alt="Foto"><button type="button" title="Entfernen">×</button>`;
        t.querySelector('button').addEventListener('click', ()=>{
          const a = safeJsonArray(hiddenEl.value);
          a.splice(idx, 1);
          hiddenEl.value = JSON.stringify(a);
          renderThumbs(thumbsEl, hiddenEl);
        });
        thumbsEl.appendChild(t);
      });
    }

    function createPhotoCollector({buttonText="Foto hinzufügen", hintText="Du kannst mehrere Fotos nacheinander hinzufügen."} = {}){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <div class="photo-actions">
          <button class="btn small" type="button" data-add>${buttonText}</button>
          <button class="btn small danger" type="button" data-clear>Fotos löschen</button>
          <input class="file-hidden" type="file" accept="image/*" capture="environment" data-file>
          <input type="hidden" value="[]" data-store>
        </div>
        <div class="thumbs" data-thumbs></div>
        <div class="smallnote">${hintText}</div>
      `;

      const btnAdd = wrap.querySelector('[data-add]');
      const btnClear = wrap.querySelector('[data-clear]');
      const file = wrap.querySelector('[data-file]');
      const store = wrap.querySelector('[data-store]');
      const thumbs = wrap.querySelector('[data-thumbs]');

      btnAdd.addEventListener('click', ()=> file.click());
      btnClear.addEventListener('click', ()=>{
        store.value = "[]";
        file.value = "";
        renderThumbs(thumbs, store);
      });

      file.addEventListener('change', async ()=>{
        if(!file.files || file.files.length === 0) return;
        const f = file.files[0];
        const dataUrl = await readFileAsDataURL(f);

        const arr = safeJsonArray(store.value);
        arr.push(dataUrl);
        store.value = JSON.stringify(arr);

        // allow adding again (also if same file was chosen)
        file.value = "";
        renderThumbs(thumbs, store);
      });

      // initial render
      renderThumbs(thumbs, store);

      // expose store for later reads
      wrap._store = store;
      return wrap;
    }

    function renderInspectionTable(tableId, rows, prefix, isInterior = false){
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = "";
      
      rows.forEach((label, idx)=>{
        const tr = document.createElement('tr');
        tr.setAttribute('data-label', label);

        const c1 = document.createElement('td');
        c1.setAttribute('data-title', 'Bereich');
        c1.textContent = label;

        const c2 = document.createElement('td');
        c2.setAttribute('data-title', 'Zustand');
        
        if(isInterior){
          const checkboxes = createInteriorStatusCheckboxes(`${prefix}_${idx}`);
          checkboxes.classList.add('interiorStatus');
          c2.appendChild(checkboxes);
        } else {
          const sel = createStatusSelect(`${prefix}_${idx}`);
          sel.classList.add('statusSelect');
          c2.appendChild(sel);
        }

        const c3 = document.createElement('td');
        c3.classList.add('note-cell');
        c3.setAttribute('data-title', 'Bemerkung');
        const ta = document.createElement('textarea');
        ta.placeholder = isInterior ? "z.B. Krümel im Fußraum, Flecken ..." : "z.B. Kratzer links, Delle 3cm, Steinschlag ...";
        ta.name = `${prefix}_note_${idx}`;
        c3.appendChild(ta);

        const c4 = document.createElement('td');
        c4.setAttribute('data-title', 'Foto(s)');
        const pc = createPhotoCollector({buttonText:"Foto +", hintText:"Optional. Bei Schaden empfohlen."});
        pc._store.classList.add('insp-photos-data');
        pc._store.name = `${prefix}_photos_${idx}`;
        c4.appendChild(pc);

        tr.appendChild(c1);
        tr.appendChild(c2);
        tr.appendChild(c3);
        tr.appendChild(c4);

        tbody.appendChild(tr);
      });
    }

    function photoCard(req){
      const div = document.createElement('div');
      div.className = 'photo-card';
      div.innerHTML = `
        <div class="meta">
          <div style="min-width:0;">
            <strong>${req.title}${req.required ? " *" : ""}</strong><br>
            <span class="muted" style="font-size:12px;">${req.hint}</span>
          </div>
          <span class="tag ${req.required ? 'ok' : ''}">${req.required ? "Pflicht" : "Optional"}</span>
        </div>
        <input type="file" id="${req.id}" accept="image/*" capture="environment" ${req.required ? "required" : ""}>
        <div class="preview" id="${req.id}_prev">
          <div class="hint">Kein Foto ausgewählt</div>
          <img alt="${req.title}">
        </div>
      `;
      return div;
    }

    let damageCounter = 0;

    function addDamageRow(){
      const tbody = document.querySelector('#tblDamage tbody');
      const nr = tbody.children.length + 1;
      damageCounter += 1;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${nr}</td>
        <td><input type="text" placeholder="z.B. hinten links" class="damage-area"></td>
        <td><textarea placeholder="z.B. Kratzer, Delle, Steinschlag ..." class="damage-desc" style="min-height:44px;"></textarea></td>
        <td><input type="text" placeholder="z.B. 5x2" class="damage-size"></td>
        <td>
          <div data-photo></div>
          <button class="btn small danger no-print" type="button" style="margin-top:8px;" data-remove>Zeile entfernen</button>
        </td>
      `;
      tbody.appendChild(tr);

      const photoCell = tr.querySelector('[data-photo]');
      const pc = createPhotoCollector({buttonText:"Schadenfoto +", hintText:"Mehrere Fotos möglich (mehrfach klicken)."});
      pc._store.classList.add('damage-photos-data');
      photoCell.appendChild(pc);

      tr.querySelector('[data-remove]').addEventListener('click', ()=>{
        tr.remove();
        renumberDamageRows();
      });
    }

    function renumberDamageRows(){
      const rows = document.querySelectorAll('#tblDamage tbody tr');
      rows.forEach((tr, idx)=>{
        tr.children[0].textContent = String(idx+1);
      });
    }

    function anyDamageSelected(){
      // Check exterior selects for "Schaden"
      const selects = document.querySelectorAll('.statusSelect');
      for(const sel of selects){
        if(sel.value === 'Schaden') return true;
      }
      // Check interior checkboxes for "Beschädigt"
      const beschaedigtCheckboxes = document.querySelectorAll('.interiorStatus input[value="Beschädigt"]:checked');
      if(beschaedigtCheckboxes.length > 0) return true;
      return false;
    }

    function hasAtLeastOneDamageEntry(){
      const rows = document.querySelectorAll('#tblDamage tbody tr');
      for(const tr of rows){
        const area = tr.querySelector('.damage-area')?.value?.trim() || "";
        const desc = tr.querySelector('.damage-desc')?.value?.trim() || "";
        const size = tr.querySelector('.damage-size')?.value?.trim() || "";
        const store = tr.querySelector('.damage-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        if(area || desc || size || photos.length) return true;
      }
      return false;
    }

    function hasInspectionDamageEvidence(){
      // Check exterior rows
      const extRows = document.querySelectorAll('#tblExterior tbody tr');
      for(const tr of extRows){
        const status = tr.querySelector('select')?.value || "";
        if(status !== "Schaden") continue;
        const note = tr.querySelector('textarea')?.value?.trim() || "";
        const store = tr.querySelector('.insp-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        if(note || photos.length) return true;
      }
      // Check interior rows for "Beschädigt"
      const intRows = document.querySelectorAll('#tblInterior tbody tr');
      for(const tr of intRows){
        const beschaedigt = tr.querySelector('input[value="Beschädigt"]:checked');
        if(!beschaedigt) continue;
        const note = tr.querySelector('textarea')?.value?.trim() || "";
        const store = tr.querySelector('.insp-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        if(note || photos.length) return true;
      }
      return false;
    }

    function mark(el, bad){
      if(!el) return;
      el.classList.toggle('error', !!bad);
    }

    function showMessage(text, kind, scroll = false){
      const box = document.getElementById('messages');
      box.classList.remove('error','ok');
      if(kind === 'error') box.classList.add('error');
      if(kind === 'ok') box.classList.add('ok');
      box.innerHTML = text;
      if(scroll || kind === 'error') {
        box.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }

    function getValue(id){
      const el = document.getElementById(id);
      return el ? el.value.trim() : "";
    }

    function getCheckbox(id){
      return document.getElementById(id).checked;
    }

    function validateForm(){
      let ok = true;

      // Pflichtfelder (Stammdaten)
      const requiredIds = ['process','date','time','location','employee','plate','model','mileage'];
      requiredIds.forEach(id=>{
        const el = document.getElementById(id);
        const bad = !el.value;
        mark(el, bad);
        if(bad) ok = false;
      });

      // Pflichtfotos (8x)
      for(const req of photoRequirements){
        const input = document.getElementById(req.id);
        const bad = req.required && (!input.files || input.files.length === 0);
        mark(input, bad);
        if(bad) ok = false;
      }

      // Mitarbeiter-Unterschrift
      const sigData = document.getElementById('sigEmployeeData').value;
      const sigCanvas = document.getElementById('sigEmployee');
      const badSig = !sigData;
      mark(sigCanvas, badSig);
      if(badSig) ok = false;

      // Wenn irgendwo Schaden gewählt: mind. ein Schadenseintrag ODER Details (Text/Foto) in Zustandsabfrage
      if(anyDamageSelected()){
        if(!hasAtLeastOneDamageEntry() && !hasInspectionDamageEvidence()){
          ok = false;
          showMessage(
            "Es wurde mindestens ein <b>Schaden</b> ausgewählt, aber es fehlen Details. Bitte entweder in der <b>Schadensliste</b> mind. 1 Zeile ausfüllen / Foto hinzufügen <u>oder</u> beim betroffenen Bereich in der <b>Zustandsabfrage</b> Text/Fotos ergänzen.",
            "error"
          );
          return false;
        }
      }

      if(!ok){
        showMessage("Bitte alle rot markierten Pflichtfelder ausfüllen – inkl. Pflichtfotos und Mitarbeiter-Unterschrift.", "error");
        return false;
      }

      showMessage("Alles ok. Du kannst jetzt <b>Senden</b> oder die <b>Druckansicht / PDF</b> öffnen.", "ok");
      return true;
    }

    function fmtDateISOToDE(iso){
      if(!iso) return "";
      const [y,m,d] = iso.split("-");
      return `${d}.${m}.${y}`;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>\"']/g, (c)=>({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
      }[c]));
    }

    async function buildReportHtml(){
      // ensure Pflichtfotos dataURLs are cached
      console.log("buildReportHtml: Checking photos...");
      for(const req of photoRequirements){
        const input = document.getElementById(req.id);
        console.log(`Photo ${req.id}: files=${input?.files?.length || 0}, cached=${!!input?.dataset?.dataurl}`);
        if(input && input.files && input.files.length>0){
          // Always re-read to ensure we have the data
          await handlePhotoInputChange(input);
          console.log(`Photo ${req.id}: after read, dataurl=${(input.dataset.dataurl||'').length} chars`);
        }
      }

      const data = {
        process: getValue('process'),
        date: fmtDateISOToDE(getValue('date')),
        time: getValue('time'),
        location: getValue('location'),
        employee: getValue('employee'),
        employeeEmail: getValue('employeeEmail'),
        plate: getValue('plate'),
        model: getValue('model'),
        mileage: getValue('mileage'),
        notesGeneral: getValue('notesGeneral'),
        exterior: [],
        interior: [],
        damage: [],
        photos: [],
        signatures: {
          employee: document.getElementById('sigEmployeeData').value
        }
      };

      // Inspection tables
      const extRows = document.querySelectorAll('#tblExterior tbody tr');
      extRows.forEach((tr)=>{
        const area = tr.children[0].textContent;
        const status = tr.querySelector('select')?.value || "";
        const note = tr.querySelector('textarea')?.value || "";
        const store = tr.querySelector('.insp-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        data.exterior.push({area, status, note, photos});
      });

      const intRows = document.querySelectorAll('#tblInterior tbody tr');
      intRows.forEach((tr)=>{
        const area = tr.children[0].textContent;
        // Interior uses checkboxes, collect all checked values
        const checkboxes = tr.querySelectorAll('input[type="checkbox"]:checked');
        const statusArr = Array.from(checkboxes).map(cb => cb.value);
        const status = statusArr.join(', ') || "";
        const note = tr.querySelector('textarea')?.value || "";
        const store = tr.querySelector('.insp-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        data.interior.push({area, status, note, photos});
      });

      // Damage table
      const dmgRows = document.querySelectorAll('#tblDamage tbody tr');
      dmgRows.forEach((tr)=>{
        const area = tr.querySelector('.damage-area')?.value?.trim() || "";
        const desc = tr.querySelector('.damage-desc')?.value?.trim() || "";
        const size = tr.querySelector('.damage-size')?.value?.trim() || "";
        const store = tr.querySelector('.damage-photos-data');
        const photos = store ? safeJsonArray(store.value) : [];
        if(area || desc || size || photos.length){
          data.damage.push({area, desc, size, photos});
        }
      });

      // Pflichtfotos
      for(const req of photoRequirements){
        const input = document.getElementById(req.id);
        const dataUrl = input.dataset.dataurl || "";
        data.photos.push({title:req.title, hint:req.hint, dataUrl});
      }

      const photosToThumbs = (arr)=>{
        if(!arr || !arr.length) return `<span style="color:#555;">-</span>`;
        return `<div class="thumbs-print">${arr.map(p=>`<img src="${p}" alt="Foto">`).join("")}</div>`;
      };

      const rowsToHtml = (arr)=> arr.map(r=>`
        <tr>
          <td>${escapeHtml(r.area)}</td>
          <td>${escapeHtml(r.status)}</td>
          <td>${escapeHtml(r.note)}</td>
          <td>${photosToThumbs(r.photos)}</td>
        </tr>
      `).join("");

      const damageToHtml = (arr)=> {
        if(!arr.length) return `<p style="margin:0; color:#444;">Keine Schadenangaben.</p>`;
        return `
          <table>
            <thead>
              <tr>
                <th style="width:18%;">Bereich</th>
                <th>Beschreibung</th>
                <th style="width:14%;">Größe</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(d=>`
                <tr>
                  <td>${escapeHtml(d.area)}</td>
                  <td>${escapeHtml(d.desc)}</td>
                  <td>${escapeHtml(d.size)}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
          ${arr.some(d=>d.photos && d.photos.length) ? `
            <div style="margin-top:10px; display:grid; grid-template-columns: repeat(4, 1fr); gap:8px;">
              ${arr.flatMap(d=> (d.photos||[]).map(p=>`<img src="${p}" alt="Schadenfoto" style="width:100%; height:200px; object-fit:cover; border:1px solid #ccc; border-radius:10px;">`)).join("")}
            </div>
          ` : ``}
        `;
      };

      const photoGridHtml = data.photos.map(p=>`
        <div style="border:1px solid #ddd; border-radius:12px; padding:10px;">
          <div style="font-weight:700; font-size:12px;">${escapeHtml(p.title)}</div>
          <div style="color:#555; font-size:11px; margin-bottom:6px;">${escapeHtml(p.hint)}</div>
          <img src="${p.dataUrl}" alt="${escapeHtml(p.title)}" style="width:100%; height:350px; object-fit:cover; border:1px solid #ccc; border-radius:10px;">
        </div>
      `).join("");

      const sigEmployeeHtml = data.signatures.employee
        ? `<img src="${data.signatures.employee}" alt="Unterschrift Mitarbeiter" style="width:100%; height:120px; object-fit:contain; border:1px solid #ccc; border-radius:10px;">`
        : `<div style="color:#b00;">Fehlt</div>`;

      // Almas Logo als Base64
      const almasLogoBase64 = "data:image/jpeg;base64,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";

      const html = `
      <!doctype html>
      <html lang="de">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Fahrzeugzustandsprotokoll - ${escapeHtml(data.plate)}</title>
        <style>
          body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 0; padding: 18px; color:#111; }
          .header{ display:flex; justify-content:space-between; align-items:center; padding-bottom:12px; border-bottom:3px solid #c8102e; margin-bottom:16px; }
          .header img{ height:50px; }
          .header-text{ text-align:right; }
          h1{ margin:0 0 6px; font-size: 18px; color:#c8102e; }
          .sub{ color:#444; font-size: 12px; margin-bottom: 12px; }
          .box{ border:1px solid #ddd; border-radius:12px; padding: 12px; margin-bottom: 12px; }
          .box-title{ font-weight:800; margin-bottom:8px; color:#c8102e; border-bottom:2px solid #c8102e; padding-bottom:4px; }
          .grid{ display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; }
          .kv{ font-size: 12px; }
          .k{ color:#555; font-size: 11px; }
          .v{ font-weight: 650; }
          table{ width:100%; border-collapse: collapse; border:1px solid #ddd; border-radius:12px; overflow:hidden; }
          th,td{ border-bottom:1px solid #eee; padding:8px; font-size: 12px; vertical-align: top; }
          th{ background:#c8102e; color:#fff; text-align:left; }
          tr:last-child td{ border-bottom:none; }
          tr:nth-child(even){ background:#fafafa; }
          .photo-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
          .thumbs-print{ display:flex; flex-wrap:wrap; gap:6px; }
          .thumbs-print img{ width:80px; height:80px; object-fit:cover; border:1px solid #ccc; border-radius:10px; }
          .no-print{ margin-bottom: 12px; }
          .btn{ border:1px solid #c8102e; background:#fff; color:#c8102e; padding: 10px 12px; border-radius: 12px; font-weight: 650; cursor:pointer; }
          .btn:hover{ background:#c8102e; color:#fff; }
          .footer{ margin-top:20px; padding-top:12px; border-top:2px solid #c8102e; text-align:center; font-size:11px; color:#555; }
          .footer strong{ color:#c8102e; }
          @media print{ .no-print{ display:none; } body{ margin:0; padding:12px; } }
        </style>
      </head>
      <body>
        <div class="no-print">
          <button class="btn" onclick="window.print()">🖨️ Drucken / als PDF speichern</button>
        </div>

        <div class="header">
          <img src="${almasLogoBase64}" alt="ALMAS INDUSTRIES">
          <div class="header-text">
            <h1>Fahrzeugzustandsprotokoll</h1>
            <div class="sub">${escapeHtml(data.process)} | ${escapeHtml(data.date)} um ${escapeHtml(data.time)}<br>Standort: ${escapeHtml(data.location)}</div>
          </div>
        </div>

        <div class="box">
          <div class="grid">
            <div class="kv" style="grid-column: span 6;"><div class="k">Mitarbeiter</div><div class="v">${escapeHtml(data.employee)}</div></div>
            <div class="kv" style="grid-column: span 6;"><div class="k">E-Mail</div><div class="v">${escapeHtml(data.employeeEmail || "-")}</div></div>

            <div class="kv" style="grid-column: span 4;"><div class="k">Kennzeichen</div><div class="v">${escapeHtml(data.plate)}</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Marke/Modell</div><div class="v">${escapeHtml(data.model)}</div></div>
            <div class="kv" style="grid-column: span 4;"><div class="k">Kilometerstand</div><div class="v">${escapeHtml(data.mileage)} km</div></div>

            <div class="kv" style="grid-column: span 12;"><div class="k">Bemerkungen</div><div class="v" style="font-weight:500;">${escapeHtml(data.notesGeneral || "-")}</div></div>
          </div>
        </div>

        <div class="box">
          <div class="box-title">Sichtprüfung außen</div>
          <table>
            <thead><tr><th style="width:28%;">Bereich</th><th style="width:14%;">Zustand</th><th>Bemerkung</th><th style="width:22%;">Foto(s)</th></tr></thead>
            <tbody>${rowsToHtml(data.exterior)}</tbody>
          </table>
        </div>

        <div class="box">
          <div class="box-title">Sichtprüfung innen</div>
          <table>
            <thead><tr><th style="width:28%;">Bereich</th><th style="width:14%;">Zustand</th><th>Bemerkung</th><th style="width:22%;">Foto(s)</th></tr></thead>
            <tbody>${rowsToHtml(data.interior)}</tbody>
          </table>
        </div>

        <div class="box">
          <div class="box-title">Schadensliste</div>
          ${damageToHtml(data.damage)}
        </div>

        <div class="box">
          <div class="box-title">Pflichtfotos</div>
          <div class="photo-grid">${photoGridHtml}</div>
        </div>

        <div class="box">
          <div class="box-title">Unterschrift Mitarbeiter</div>
          ${sigEmployeeHtml}
        </div>

        <div class="footer">
          <strong>ALMAS INDUSTRIES AG</strong><br>
          Floßwörthstraße 57 | D-68199 Mannheim<br>
          Tel.: +49 (0) 621 / 842 528 – 0 | www.totmann-schalter.de
        </div>
      </body>
      </html>
      `;
      return { html, data };
    }

    function downloadFile(filename, content, mime){
      const blob = new Blob([content], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=> URL.revokeObjectURL(url), 2500);
    }

    async function exportJson(){
      const { data } = await buildReportHtml();
      const json = JSON.stringify(data, null, 2);
      const safePlate = (data.plate || "fahrzeug").replace(/[^a-z0-9\-]+/gi,'_');
      downloadFile(`fahrzeugprotokoll_${safePlate}_${(data.date||'').replace(/\./g,'-')}.json`, json, "application/json");
      showMessage("JSON Export erstellt (Download sollte gestartet sein).", "ok");
    }

    async function openPrintView(){
      const { html } = await buildReportHtml();
      const w = window.open("", "_blank");
      if(!w){
        showMessage("Pop-up blockiert. Bitte Pop-ups erlauben oder manuell drucken.", "error");
        return;
      }
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
    }

    // Webhook URL (HTTPS via nginx + Let's Encrypt)
    const WEBHOOK_URL = "https://webhook.dokumente-almas.de/webhook/fahrzeugprotokoll";

    async function sendProtocol(){
      if(!validateForm()) return;

      const { html, data } = await buildReportHtml();
      
      // Show loading state
      const btnSend = document.getElementById('btnSend');
      const originalText = btnSend.textContent;
      btnSend.textContent = "Wird gesendet...";
      btnSend.disabled = true;
      showMessage("📤 Protokoll wird übertragen... Bitte warten.", "ok");

      try {
        const response = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.success) {
          showMessage(`✅ <b>Protokoll erfolgreich gesendet!</b><br>
            📁 <a href="${result.driveLink}" target="_blank">Fotos in Google Drive öffnen</a><br>
            📧 E-Mail wurde versendet.`, "ok");
        } else {
          throw new Error(result.message || "Unbekannter Fehler");
        }

      } catch (err) {
        console.error("Send error:", err);
        showMessage(`❌ <b>Fehler beim Senden:</b> ${err.message}<br>
          Bitte versuchen Sie es erneut oder nutzen Sie die <b>Druckansicht / PDF</b> Funktion.`, "error");
        
        // Fallback: offer download
        const safePlate = (data.plate || "fahrzeug").replace(/[^a-z0-9\-]+/gi,'_');
        const baseName = `fahrzeugprotokoll_${safePlate}_${(data.date||'').replace(/\./g,'-')}`;
        downloadFile(`${baseName}.html`, html, "text/html");
        downloadFile(`${baseName}.json`, JSON.stringify(data, null, 2), "application/json");
      } finally {
        btnSend.textContent = originalText;
        btnSend.disabled = false;
      }
    }

    // Signature pads (simple, no external libs)
    function setupSignaturePad(canvasId, hiddenId, clearBtnId){
      const canvas = document.getElementById(canvasId);
      const hidden = document.getElementById(hiddenId);
      const clearBtn = document.getElementById(clearBtnId);

      let drawing = false;
      let hasInk = false;
      let last = {x:0, y:0};

      function resize(){
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.floor(rect.width * ratio);
        canvas.height = Math.floor(rect.height * ratio);
        const ctx = canvas.getContext('2d');
        ctx.scale(ratio, ratio);
        ctx.lineWidth = 2.2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000000';

        if(hasInk){
          const imgData = hidden.value;
          if(imgData){
            const img = new Image();
            img.onload = ()=> ctx.drawImage(img, 0, 0, rect.width, rect.height);
            img.src = imgData;
          }else{
            ctx.clearRect(0,0,rect.width, rect.height);
          }
        }else{
          ctx.clearRect(0,0,rect.width, rect.height);
        }
      }

      function pos(evt){
        const rect = canvas.getBoundingClientRect();
        return {
          x: (evt.clientX - rect.left),
          y: (evt.clientY - rect.top)
        };
      }

      function start(evt){
        drawing = true;
        const p = pos(evt);
        last = p;
      }

      function move(evt){
        if(!drawing) return;
        const ctx = canvas.getContext('2d');
        const p = pos(evt);
        ctx.beginPath();
        ctx.moveTo(last.x, last.y);
        ctx.lineTo(p.x, p.y);
        ctx.stroke();
        last = p;
        hasInk = true;
        hidden.value = canvas.toDataURL("image/png");
      }

      function end(){
        drawing = false;
        if(hasInk){
          hidden.value = canvas.toDataURL("image/png");
        }
      }

      function clear(){
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        hasInk = false;
        hidden.value = "";
      }

      canvas.addEventListener('pointerdown', (e)=>{ canvas.setPointerCapture(e.pointerId); start(e); });
      canvas.addEventListener('pointermove', (e)=> move(e));
      canvas.addEventListener('pointerup', ()=> end());
      canvas.addEventListener('pointercancel', ()=> end());
      clearBtn.addEventListener('click', clear);
      window.addEventListener('resize', resize);

      resize();
      return { clear, get hasInk(){ return hasInk; } };
    }

    function init(){
      setNowDefaults();

      renderInspectionTable("tblExterior", exteriorRows, "ext", false);
      renderInspectionTable("tblInterior", interiorRows, "int", true);

      // Damage table - start with one row
      addDamageRow();
      document.getElementById('btnAddDamage').addEventListener('click', addDamageRow);

      // Pflichtfotos
      const grid = document.getElementById('photoGrid');
      photoRequirements.forEach(req=>{
        const card = photoCard(req);
        grid.appendChild(card);
      });

      photoRequirements.forEach(req=>{
        const input = document.getElementById(req.id);
        input.addEventListener('change', ()=> handlePhotoInputChange(input));
      });

      // Signatures
      setupSignaturePad('sigEmployee','sigEmployeeData','clearSigEmployee');
      // Kunden-Unterschrift entfernt

      // Buttons
      document.getElementById('btnSend').addEventListener('click', async ()=>{
        await sendProtocol();
      });

      document.getElementById('btnPrint').addEventListener('click', async ()=>{
        if(!validateForm()) return;
        await openPrintView();
      });

      document.getElementById('btnReset').addEventListener('click', ()=>{
        if(!confirm("Wirklich alles zurücksetzen?")) return;
        location.reload();
      });

      showMessage("Fülle das Protokoll aus. Danach kannst du es <b>Senden</b> oder die <b>Druckansicht / PDF</b> öffnen.", "ok");

      // Dark Mode Toggle
      const darkModeBtn = document.getElementById('btnDarkMode');
      const iconSun = document.getElementById('iconSun');
      const iconMoon = document.getElementById('iconMoon');
      
      // Check saved preference or system preference
      const savedDark = localStorage.getItem('darkMode');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      function setDarkMode(isDark) {
        document.body.classList.toggle('dark', isDark);
        iconSun.style.display = isDark ? 'none' : 'block';
        iconMoon.style.display = isDark ? 'block' : 'none';
        localStorage.setItem('darkMode', isDark ? '1' : '0');
      }
      
      // Initialize
      if (savedDark === '1' || (savedDark === null && prefersDark)) {
        setDarkMode(true);
      }
      
      darkModeBtn.addEventListener('click', () => {
        setDarkMode(!document.body.classList.contains('dark'));
      });
    }

    init();
  </script>

</body>
</html>
